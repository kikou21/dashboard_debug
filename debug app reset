Parfait ğŸ‘
Voici juste les lignes Ã  ajouter ou modifier dans ta route /disconnect, sans tout recopier :


---

ğŸŸ¢ Ã€ ajouter aprÃ¨s :

app.logger.info(f"[logout] {username} dÃ©connectÃ© manuellement ")

â¡ï¸ ajoute :

# ğŸ” RÃ©initialise la demo-app pour ce user
try:
    ns = get_namespace(username)
    api = client.AppsV1Api()
    name = f"{RELEASE_NAME}-demo-app-{username}"
    api.patch_namespaced_deployment_scale(name, ns, {"spec": {"replicas": 1}})
    app.logger.info(f"[logout] Demo-app de {username} rÃ©initialisÃ©e Ã  1 pod")
except Exception as e:
    app.logger.warning(f"[logout] Reset demo-app Ã©chouÃ© pour {username}: {e}")


---

ğŸŸ¡ Et Ã  ajouter aussi aprÃ¨s :

r.set(f"user:{username}:closed_at", ts)
app.logger.info(f"[disconnect] ClÃ©s Redis supprimÃ©es pour {username} (fermeture sauvage t)closed_at={ts}")

â¡ï¸ ajoute juste aprÃ¨s :

# ğŸ§¹ Optionnel : reset aussi la demo-app en cas de fermeture sauvage
try:
    ns = get_namespace(username)
    api = client.AppsV1Api()
    name = f"{RELEASE_NAME}-demo-app-{username}"
    api.patch_namespaced_deployment_scale(name, ns, {"spec": {"replicas": 1}})
    app.logger.info(f"[disconnect] Demo-app de {username} rÃ©initialisÃ©e Ã  1 pod aprÃ¨s fermeture sauvage")
except Exception as e:
    app.logger.warning(f"[disconnect] Reset demo-app Ã©chouÃ© (fermeture sauvage) pour {username}: {e}")


---

ğŸ‘‰ Rien dâ€™autre Ã  toucher.
Tu gardes tout le reste du code identique.

Ã‡a permet Ã  Flask de rÃ©initialiser la demo-app cÃ´tÃ© serveur aussi bien :

quand lâ€™utilisateur clique sur DÃ©connexion

que lors dâ€™une fermeture sauvage (via sendBeacon).


