TrÃ¨s bonne remarque ğŸ’¡ â€” oui, il faut aussi un petit dÃ©lai (setTimeout) dans le cas leaving_for_demo, sinon certains navigateurs (notamment Edge et Firefox) ferment la page avant que le flag ait Ã©tÃ© correctement supprimÃ© ou que la redirection vers la demo ait commencÃ©.


---

Voici donc la version finale complÃ¨te et propre de la fonction,
avec un setTimeout aussi bien pour le dÃ©part vers demo-app que pour la fermeture sauvage ğŸ‘‡

// ===================== FERMETURE SAUVAGE / REFRESH =====================
function registerDisconnectHandler() {
  window.addEventListener("beforeunload", () => {
    const user = currentUser();
    const leavingForDemo = sessionStorage.getItem("leaving_for_demo");

    if (!user) {
      // Aucun user stockÃ© â†’ ne rien faire
      return;
    } else if (leavingForDemo === "1") {
      // Cas : dÃ©part vers demo-app â†’ pas de disconnect
      console.log("â†©ï¸ Retour vers demo-app â€” pas de disconnect");
      // lÃ©ger dÃ©lai pour laisser le flag et la redirection sâ€™exÃ©cuter
      setTimeout(() => {
        sessionStorage.removeItem("leaving_for_demo");
      }, 100);
      return;
    } else {
      // Cas : fermeture ou rechargement â†’ envoi disconnect
      const payload = JSON.stringify({ user });
      console.log(`ğŸšª DÃ©connexion sauvage dÃ©tectÃ©e pour ${user}`);

      setTimeout(() => {
        try {
          navigator.sendBeacon("/disconnect", payload);
        } catch (e) {
          fetch("/disconnect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: payload,
            keepalive: true,
          }).catch(() => {});
        }
      }, 100); // 100 ms de dÃ©lai pour laisser le navigateur traiter lâ€™Ã©vÃ©nement
    }
  });
}

// ğŸ” Active la gestion de la dÃ©connexion sauvage
registerDisconnectHandler();


---

âš™ï¸ En rÃ©sumÃ© :

âœ… setTimeout ajoutÃ© dans les deux cas :

dÃ©part vers demo-app â†’ laisse le flag se vider proprement

fermeture sauvage â†’ laisse le sendBeacon partir


âœ… Compatible tous navigateurs

âœ… Aucun blocage du thread (contrairement Ã  while)



---

Souhaites-tu que je tâ€™envoie la mÃªme version adaptÃ©e pour la demo-app (avec ${dashboard_url}/disconnect) pour garder une cohÃ©rence entre les deux fronts ?

